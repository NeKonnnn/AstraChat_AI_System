"""
–ê–≥–µ–Ω—Ç PromptEngineer - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ –∏ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
"""

import logging
from typing import Dict, List, Any, Optional
from .base_agent import BaseAgent

logger = logging.getLogger(__name__)

class PromptEngineer(BaseAgent):
    """–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤"""
    
    def __init__(self):
        super().__init__(
            name="prompt_engineer",
            description="–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, —É–ª—É—á—à–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è LLM"
        )
        
        self.capabilities = [
            "prompt_creation",
            "prompt_enhancement",
            "prompt_optimization",
            "prompt_analysis",
            "prompt_engineering"
        ]
    
    async def process_message(self, message: str, context: Dict[str, Any] = None) -> str:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–∞–±–æ—Ç—É —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏"""
        try:
            logger.info(f"[PromptEngineer] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {message[:100]}...")
            
            # –ü–æ–ª—É—á–∞–µ–º ask_agent –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º
            try:
                from backend.agent import ask_agent
            except ModuleNotFoundError:
                from agent import ask_agent
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥
            message_lower = message.lower()
            
            # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
            if any(keyword in message_lower for keyword in ["—É–ª—É—á—à–∏", "–æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π", "—Å–¥–µ–ª–∞–π –ª—É—á—à–µ", "enhance", "improve", "optimize"]):
                return await self._enhance_prompt(message, context, ask_agent)
            
            # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–º–ø—Ç–∞
            elif any(keyword in message_lower for keyword in ["–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π", "–æ—Ü–µ–Ω–∏", "analyze", "evaluate", "review", "–∫–∞—á–µ—Å—Ç–≤–æ"]):
                return await self._analyze_prompt(message, context, ask_agent)
            
            # –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            elif any(keyword in message_lower for keyword in ["—Å–æ—Ö—Ä–∞–Ω–∏", "–¥–æ–±–∞–≤—å –≤ –≥–∞–ª–µ—Ä–µ—é", "save", "add to gallery"]):
                return await self._save_prompt(message, context, ask_agent)
            
            # –ò–Ω–∞—á–µ - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
            else:
                return await self._create_prompt(message, context, ask_agent)
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ PromptEngineer: {e}")
            import traceback
            logger.error(traceback.format_exc())
            return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}"
    
    async def _create_prompt(
        self, 
        description: str, 
        context: Dict[str, Any], 
        ask_agent
    ) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ –ø—Ä–æ—Å—Ç–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è"""
        
        system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ (Prompt Engineering) –¥–ª—è —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç.

–ü–†–ò–ù–¶–ò–ü–´ –°–û–ó–î–ê–ù–ò–Ø –≠–§–§–ï–ö–¢–ò–í–ù–´–• –ü–†–û–ú–ü–¢–û–í:

1. –ß–ï–¢–ö–ê–Ø –†–û–õ–¨ –ò –ö–û–ù–¢–ï–ö–°–¢
   - –û–ø—Ä–µ–¥–µ–ª–∏ —Ä–æ–ª—å AI (—ç–∫—Å–ø–µ—Ä—Ç, –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ —Ç.–¥.)
   - –£—Å—Ç–∞–Ω–æ–≤–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏
   - –£–∫–∞–∂–∏ –æ–±–ª–∞—Å—Ç—å –∑–Ω–∞–Ω–∏–π

2. –ö–û–ù–ö–†–ï–¢–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò
   - –ò—Å–ø–æ–ª—å–∑—É–π —á–µ—Ç–∫–∏–µ, –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
   - –ò–∑–±–µ–≥–∞–π –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–µ–π
   - –†–∞–∑–±–µ–π —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —à–∞–≥–∏

3. –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –§–û–†–ú–ê–¢
   - –û—Ä–≥–∞–Ω–∏–∑—É–π –ø—Ä–æ–º–ø—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏
   - –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–¥–µ–ª—ã –∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã
   - –ü—Ä–∏–º–µ–Ω—è–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

4. –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ò –¢–†–ï–ë–û–í–ê–ù–ò–Ø
   - –£–∫–∞–∂–∏ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (JSON, —Å–ø–∏—Å–æ–∫, —Ç–∞–±–ª–∏—Ü–∞ –∏ —Ç.–¥.)
   - –û–ø—Ä–µ–¥–µ–ª–∏ –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
   - –ó–∞–¥–∞–π —Å—Ç–∏–ª—å (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π)

5. –ü–†–ò–ú–ï–†–´ –ò –®–ê–ë–õ–û–ù–´
   - –î–æ–±–∞–≤—å –ø—Ä–∏–º–µ—Ä—ã –∂–µ–ª–∞–µ–º–æ–≥–æ –≤—ã–≤–æ–¥–∞
   - –ü–æ–∫–∞–∂–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ
   - –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π –æ–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç

6. –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
   - –£–∫–∞–∂–∏, —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
   - –û–ø—Ä–µ–¥–µ–ª–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏
   - –ó–∞–¥–∞–π –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è edge cases

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

=== –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ ===

[–ó–¥–µ—Å—å –ø–æ–ª–Ω—ã–π —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –≥–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é]

=== –û–ë–™–Ø–°–ù–ï–ù–ò–ï –£–õ–£–ß–®–ï–ù–ò–ô ===

1. –†–æ–ª—å –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç: [–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞]
2. –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è: [—Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π]
3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: [–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–º–ø—Ç–∞]
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é: [—Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é]

=== –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –í–ê–†–ò–ê–ù–¢–´ ===

[–ö—Ä–∞—Ç–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ]

=== –ú–ï–¢–†–ò–ö–ò –ö–ê–ß–ï–°–¢–í–ê ===

- –ß–µ—Ç–∫–æ—Å—Ç—å: [–æ—Ü–µ–Ω–∫–∞]
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ—Å—Ç—å: [–æ—Ü–µ–Ω–∫–∞]
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: [–æ—Ü–µ–Ω–∫–∞]
- –ü–æ–ª–Ω–æ—Ç–∞: [–æ—Ü–µ–Ω–∫–∞]

–°–æ–∑–¥–∞–π –ø—Ä–æ–º–ø—Ç –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ, —á—Ç–æ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

        user_prompt = f"""–°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è:

–û–ü–ò–°–ê–ù–ò–ï –ó–ê–î–ê–ß–ò:
{description}

–°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∏–ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç LLM. 
–ü—Ä–∏–º–µ–Ω–∏ –≤—Å–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤."""

        logger.info("[PromptEngineer] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞...")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        history = context.get("history", []) if context else []
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
        selected_model = context.get("selected_model") if context else None
        
        # –í–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç
        full_prompt = f"{system_prompt}\n\n{user_prompt}"
        
        if selected_model:
            response = ask_agent(
                full_prompt,
                history=[],
                streaming=False,
                model_path=selected_model
            )
        else:
            response = ask_agent(
                full_prompt,
                history=[],
                streaming=False
            )
        
        logger.info(f"[PromptEngineer] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, –¥–ª–∏–Ω–∞: {len(response)} —Å–∏–º–≤–æ–ª–æ–≤")
        return response
    
    async def _enhance_prompt(
        self, 
        message: str, 
        context: Dict[str, Any], 
        ask_agent
    ) -> str:
        """–£–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""
        
        system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —É–ª—É—á—à–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–ø—Ç, —Å–¥–µ–ª–∞–≤ –µ–≥–æ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.

–ü–†–ò–ù–¶–ò–ü–´ –£–õ–£–ß–®–ï–ù–ò–Ø:
1. –î–æ–±–∞–≤—å —á–µ—Ç–∫—É—é —Ä–æ–ª—å –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
2. –°–¥–µ–ª–∞–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏
3. –î–æ–±–∞–≤—å —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
4. –£–ª—É—á—à–∏ –ª–æ–≥–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
5. –î–æ–±–∞–≤—å –ø—Ä–∏–º–µ—Ä—ã, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç
6. –£–±–µ—Ä–∏ –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏
7. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

=== –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ ===

[–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–º–ø—Ç–∞, –≥–æ—Ç–æ–≤–∞—è –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é]

=== –ß–¢–û –ë–´–õ–û –£–õ–£–ß–®–ï–ù–û ===

1. [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ 1 —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º]
2. [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ 2 —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º]
3. [–ò —Ç.–¥.]

=== –°–†–ê–í–ù–ï–ù–ò–ï ===

–î–û:
[–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞]

–ü–û–°–õ–ï:
[–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞]

=== –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢ ===

[–û–ø–∏—à–∏, –∫–∞–∫ —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞]"""

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        prompt_text = self._extract_prompt_from_message(message)
        
        user_prompt = f"""–£–ª—É—á—à–∏ —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ–º–ø—Ç, —Å–¥–µ–ª–∞–≤ –µ–≥–æ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º:

–û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–ú–ü–¢:
{prompt_text}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–º–ø—Ç –∏ —Å–æ–∑–¥–∞–π —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π."""

        logger.info("[PromptEngineer] –£–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞...")
        
        history = context.get("history", []) if context else []
        selected_model = context.get("selected_model") if context else None
        
        # –í–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç
        full_prompt = f"{system_prompt}\n\n{user_prompt}"
        
        if selected_model:
            response = ask_agent(
                full_prompt,
                history=[],
                streaming=False,
                model_path=selected_model
            )
        else:
            response = ask_agent(
                full_prompt,
                history=[],
                streaming=False
            )
        
        return response
    
    async def _analyze_prompt(
        self, 
        message: str, 
        context: Dict[str, Any], 
        ask_agent
    ) -> str:
        """–ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–º–ø—Ç–∞"""
        
        system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –∏ –¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.

–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò (0-10):
1. –ß–µ—Ç–∫–æ—Å—Ç—å —Ä–æ–ª–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
2. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
3. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
4. –ù–∞–ª–∏—á–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞
5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–µ–π
6. –ü–æ–ª–Ω–æ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
7. –ü—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å –ø—Ä–∏–º–µ—Ä–æ–≤
8. –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:

=== –ê–ù–ê–õ–ò–ó –ü–†–û–ú–ü–¢–ê ===

–û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: [X/10]
–£–†–û–í–ï–ù–¨: [–ù–∞—á–∏–Ω–∞—é—â–∏–π/–°—Ä–µ–¥–Ω–∏–π/–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π/–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π]

=== –î–ï–¢–ê–õ–¨–ù–ê–Ø –û–¶–ï–ù–ö–ê ===

1. –ß–µ—Ç–∫–æ—Å—Ç—å —Ä–æ–ª–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

2. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

3. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

4. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–µ–π: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

6. –ü–æ–ª–Ω–æ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

7. –ü—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å –ø—Ä–∏–º–µ—Ä–æ–≤: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

8. –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases: [X/10]
   ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]
   ‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: [—Å–ø–∏—Å–æ–∫]

=== –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ ===

1. [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1 —Å –ø—Ä–∏–º–µ—Ä–æ–º]
2. [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2 —Å –ø—Ä–∏–º–µ—Ä–æ–º]
3. [–ò —Ç.–¥.]

=== –ü–†–ò–û–†–ò–¢–ï–¢–´ ===

üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ: [—á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å]
üü° –í–∞–∂–Ω–æ: [—á—Ç–æ —Å—Ç–æ–∏—Ç —É–ª—É—á—à–∏—Ç—å]
üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ: [—á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞]"""

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        prompt_text = self._extract_prompt_from_message(message)
        
        user_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ–º–ø—Ç –∏ –¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É:

–ü–†–û–ú–ü–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
{prompt_text}

–û—Ü–µ–Ω–∏ –ø—Ä–æ–º–ø—Ç –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∏ –¥–∞–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é."""

        logger.info("[PromptEngineer] –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–º–ø—Ç–∞...")
        
        history = context.get("history", []) if context else []
        selected_model = context.get("selected_model") if context else None
        
        # –í–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç
        full_prompt = f"{system_prompt}\n\n{user_prompt}"
        
        if selected_model:
            response = ask_agent(
                full_prompt,
                history=[],
                streaming=False,
                model_path=selected_model
            )
        else:
            response = ask_agent(
                full_prompt,
                history=[],
                streaming=False
            )
        
        return response
    
    async def _save_prompt(
        self, 
        message: str, 
        context: Dict[str, Any], 
        ask_agent
    ) -> str:
        """–ü–æ–º–æ—â—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞"""
        
        return """–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ –≤ –≥–∞–ª–µ—Ä–µ—é:

1. –ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª "–ì–∞–ª–µ—Ä–µ—è –ø—Ä–æ–º–ø—Ç–æ–≤"
2. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç"
3. –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É:
   - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
   - –û–ø–∏—Å–∞–Ω–∏–µ
   - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–º–ø—Ç–∞
   - –¢–µ–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –í—ã–±–µ—Ä–∏ –≤–∏–¥–∏–º–æ—Å—Ç—å (–ø—É–±–ª–∏—á–Ω—ã–π/–ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
5. –°–æ—Ö—Ä–∞–Ω–∏

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç save_prompt_to_gallery –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."""
    
    def _extract_prompt_from_message(self, message: str) -> str:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø—Ä–æ–º–ø—Ç –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        import re
        
        # –ò—â–µ–º —Ç–µ–∫—Å—Ç –≤ –∫–∞–≤—ã—á–∫–∞—Ö
        quoted = re.findall(r'["""](.*?)["""]', message, re.DOTALL)
        if quoted:
            return quoted[0].strip()
        
        # –ò—â–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        keywords = ["–ø—Ä–æ–º–ø—Ç:", "prompt:", "—Ç–µ–∫—Å—Ç:", "—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:"]
        for keyword in keywords:
            if keyword.lower() in message.lower():
                parts = message.split(keyword, 1)
                if len(parts) > 1:
                    return parts[1].strip()
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        return message.strip()
    
    def can_handle(self, message: str, context: Dict[str, Any] = None) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –∞–≥–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        message_lower = message.lower()
        
        prompt_keywords = [
            "–ø—Ä–æ–º–ø—Ç", "prompt", "—Å–æ–∑–¥–∞–π –ø—Ä–æ–º–ø—Ç", "—É–ª—É—á—à–∏ –ø—Ä–æ–º–ø—Ç", 
            "–æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –ø—Ä–æ–º–ø—Ç", "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–º–ø—Ç", "–æ—Ü–µ–Ω–∏ –ø—Ä–æ–º–ø—Ç",
            "—Å–¥–µ–ª–∞–π –ø—Ä–æ–º–ø—Ç", "–Ω–∞–ø–∏—à–∏ –ø—Ä–æ–º–ø—Ç", "–ø–æ–º–æ–≥–∏ —Å –ø—Ä–æ–º–ø—Ç–æ–º",
            "–∫–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–º–ø—Ç", "–∫–∞–∫ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º–ø—Ç", "—Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç –¥–ª—è",
            "enhance prompt", "improve prompt", "create prompt", "analyze prompt",
            "prompt engineering", "–∏–Ω–∂–µ–Ω–µ—Ä–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤", "–∏–Ω–∂–µ–Ω–µ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤",
            "prompt engineer", "–ø–æ–º–æ—â—å —Å –ø—Ä–æ–º–ø—Ç–æ–º", "help with prompt"
        ]
        
        return any(keyword in message_lower for keyword in prompt_keywords)

